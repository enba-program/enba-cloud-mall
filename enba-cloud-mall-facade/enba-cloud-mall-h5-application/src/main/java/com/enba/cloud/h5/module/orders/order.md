# 商城系统订单模块完整业务流程设计

## 一、订单状态定义

### 1. 订单状态

| 状态码 | 状态名称 | 描述                   |
|-----|------|----------------------|
| 0   | 待付款  | 用户已提交订单但未完成支付        |
| 1   | 已付款  | 用户已完成支付，等待发货         |
| 2   | 已发货  | 商品已发出，等待用户收货         |
| 3   | 已完成  | 用户已确认收货，交易完成         |
| 4   | 已取消  | 用户主动取消订单（未付款）        |
| 5   | 已关闭  | 系统自动关闭订单（未付款超时或其他原因） |
| 6   | 退款中  | 用户申请退款，正在处理中         |
| 7   | 已退款  | 退款已完成                |

### 2. 支付状态

| 状态码 | 状态名称 | 描述      |
|-----|------|---------|
| 0   | 未支付  | 订单尚未支付  |
| 1   | 已支付  | 订单已成功支付 |
| 2   | 支付失败 | 支付尝试失败  |

### 3. 物流状态

| 状态码 | 状态名称 | 描述        |
|-----|------|-----------|
| 0   | 未发货  | 商品尚未发出    |
| 1   | 已发货  | 商品已发出     |
| 2   | 已收货  | 用户已确认收到商品 |

## 二、完整业务流程

### 1. 订单创建与待付款阶段

#### 1.1 用户下单

- 用户浏览商品并提交订单
- 系统生成订单，初始状态：
    - 订单状态：0（待付款）
    - 支付状态：0（未支付）
    - 物流状态：0（未发货）

#### 1.2 支付处理

- 用户选择支付方式并完成支付
- 系统接收支付结果：
    - **支付成功**：
        - 更新支付状态：1（已支付）
        - 更新订单状态：1（已付款）
        - 触发订单处理流程（如库存锁定、发货准备）
    - **支付失败**：
        - 更新支付状态：2（支付失败）
        - 订单状态保持：0（待付款）
        - 提示用户重新支付或取消订单

#### 1.3 订单自动关闭（可选）

- 如果订单长时间未支付（如30分钟）：
    - 系统自动更新订单状态：5（已关闭）
    - 支付状态保持：0（未支付）
    - 物流状态保持：0（未发货）

### 2. 订单处理与发货阶段

#### 2.1 订单审核与准备

- 系统检查订单有效性（库存、商品状态等）
- 准备发货（拣货、打包等）

#### 2.2 发货处理

- 物流公司取件或仓库发货
- 系统更新：
    - 物流状态：1（已发货）
    - 订单状态：2（已发货）
- 发送物流通知给用户（快递单号、物流公司等）

### 3. 订单完成阶段

#### 3.1 用户确认收货

- 用户收到商品后，在系统中确认收货
- 系统更新：
    - 物流状态：2（已收货）
    - 订单状态：3（已完成）
- 交易完成，可进行评价等后续操作

#### 3.2 自动确认收货（可选）

- 如果用户未主动确认收货，系统在设定时间后（如7天）自动：
    - 更新物流状态：2（已收货）
    - 更新订单状态：3（已完成）

### 4. 订单取消流程

#### 4.1 用户主动取消（待付款阶段）

- 订单状态为0（待付款）时，用户可申请取消订单
- 系统处理：
    - 更新订单状态：4（已取消）
    - 支付状态保持：0（未支付）
    - 物流状态保持：0（未发货）
    - 释放相关库存

#### 4.2 系统关闭订单

- 订单状态为0（待付款）且超时未支付：
    - 系统自动更新订单状态：5（已关闭）
    - 支付状态保持：0（未支付）
    - 物流状态保持：0（未发货）
- 其他系统规则导致的关闭（如商品下架、库存不足等）：
    - 系统自动更新订单状态：5（已关闭）
    - 支付状态保持：0（未支付）
    - 物流状态保持：0（未发货）

### 5. 退款流程

#### 5.1 申请退款

- 用户在订单状态为1（已付款）或2（已发货）时申请退款
- 系统处理：
    - 更新订单状态：6（退款中）
    - 调用支付接口发起退款

#### 5.2 退款处理中

- 订单状态：6（退款中）
- 支付平台处理退款请求

#### 5.3 退款完成

- 支付平台回调确认退款成功
- 系统处理：
    - 更新支付状态：0（未支付）
    - 更新订单状态：7（已退款）
    - 如果商品未发货：
        - 物流状态：0（未发货）
        - 释放相关库存
    - 如果商品已发货：
        - 物流状态保持不变（需用户退货后才能完全关闭订单）
        - 可能需要启动退货流程

### 6. 退货流程（可选扩展）

#### 6.1 申请退货

- 用户在订单状态为3（已完成）时申请退货
- 系统处理：
    - 更新订单状态：6（退款中）
    - 记录退货申请信息

#### 6.2 退货处理

- 用户退回商品
- 系统确认收到退货
- 处理退款：
    - 更新支付状态：0（未支付）
    - 更新订单状态：7（已退款）
    - 更新物流状态：0（未发货）
    - 释放相关库存

## 三、状态转换规则与限制

### 订单状态转换矩阵

| 当前状态   | 可转换状态  | 触发条件          |
|--------|--------|---------------|
| 0（待付款） | 1（已付款） | 支付成功          |
| 0（待付款） | 4（已取消） | 用户主动取消        |
| 0（待付款） | 5（已关闭） | 超时未支付或系统关闭    |
| 1（已付款） | 2（已发货） | 仓库发货          |
| 1（已付款） | 6（退款中） | 用户申请退款        |
| 1（已付款） | 5（已关闭） | 系统关闭（如库存不足）   |
| 2（已发货） | 3（已完成） | 用户确认收货        |
| 2（已发货） | 6（退款中） | 用户申请退款        |
| 3（已完成） | 7（已退款） | 用户申请退货并完成退货流程 |
| 4（已取消） | -      | 不可逆           |
| 5（已关闭） | -      | 不可逆           |
| 6（退款中） | 7（已退款） | 退款完成          |
| 6（退款中） | 1（已付款） | 退款失败（需重新处理）   |

### 支付状态转换规则

- 0（未支付） → 1（已支付）：支付成功
- 0（未支付） → 2（支付失败）：支付失败
- 1（已支付） → 0（未支付）：退款完成
- 2（支付失败） → 1（已支付）：重新支付成功

### 物流状态转换规则

- 0（未发货） → 1（已发货）：商品发出
- 1（已发货） → 2（已收货）：用户确认收货
- 2（已收货） → - | 不可逆（除非启动退货流程）

## 四、异常处理与边界情况

1. **重复支付处理**
    - 系统应检测重复支付请求，避免重复扣款
    - 如发生重复支付，应自动退款多余金额

2. **支付回调失败**
    - 支付平台回调失败时，系统应记录日志并重试
    - 设置最大重试次数，超过后人工介入处理

3. **退款失败处理**
    - 退款失败时，系统应记录失败原因
    - 可设置自动重试或通知人工处理

4. **库存不足处理**
    - 订单准备发货时发现库存不足：
        - 更新订单状态：5（已关闭）
        - 触发退款流程（如已支付）

5. **物流异常处理**
    - 物流信息长时间未更新：
        - 系统可发送提醒给仓库或物流公司
        - 如确认无法送达，可启动退款流程

## 五、业务流程图

```mermaid
graph TD
    A[用户下单] --> B[订单状态0，支付状态0]
    B --> C{支付处理}
    C -->|支付成功| D[订单状态1，支付状态1]
    C -->|支付失败| E[订单状态0，支付状态2]
    D --> F[发货处理]
    F --> G[物流状态1，订单状态2]
    G --> H{用户确认收货?}
    H -->|是| I[物流状态2，订单状态3]
    H -->|否| J[自动确认收货]
    J --> I
    E --> K[订单状态5（已关闭）]
    B -->|超时未支付| K
    D --> L{用户申请退款?}
    L -->|是| M[订单状态6]
    L -->|否| N[继续]
    M --> O{退款完成?}
    O -->|是| P[订单状态7，支付状态0]
    O -->|否| M